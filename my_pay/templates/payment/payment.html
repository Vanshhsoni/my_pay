<!DOCTYPE html>
<html>
<head>
  <title>Payment Debug</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body style="text-align:center; background:#e8f5e9; font-family:Arial; padding:20px;">
  <h2>Payment Debug Mode</h2>
  
  {% if error %}
  <div style="background:#ffebee; color:#c62828; padding:15px; margin:20px auto; max-width:600px; border-radius:8px;">
    <h3>Error:</h3>
    <p>{{ error }}</p>
  </div>
  {% endif %}
  
  {% if not order_id and not error %}
  <form method="POST">
    {% csrf_token %}
    <button type="submit" style="padding:12px 20px; background:green; color:white; border:none; border-radius:8px;">
      Pay ‚Çπ1 (Debug Mode)
    </button>
  </form>
  {% endif %}

  {% if order_id %}
  <div id="debug-info" style="background:#fff3cd; padding:15px; margin:20px auto; max-width:600px; border-radius:8px; text-align:left;">
    <h3>Debug Information:</h3>
    <p><strong>Order ID:</strong> {{ order_id }}</p>
    <p><strong>Amount:</strong> {{ amount }} paise (‚Çπ1)</p>
    <p><strong>Razorpay Key:</strong> {{ razorpay_key }}</p>
  </div>

  <div id="status" style="margin:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
    <p id="current-status">Initializing payment...</p>
  </div>

  <div id="debug-log" style="margin:20px; padding:15px; background:#f0f0f0; border-radius:8px; text-align:left; font-family:monospace; font-size:12px; max-height:200px; overflow-y:scroll;"></div>

  <script>
    function updateStatus(message, color = '#333') {
      const statusEl = document.getElementById('current-status');
      statusEl.innerHTML = message;
      statusEl.style.color = color;
      addDebugLog('STATUS: ' + message);
    }

    function addDebugLog(message) {
      const debugLog = document.getElementById('debug-log');
      const timestamp = new Date().toLocaleTimeString();
      debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
      debugLog.scrollTop = debugLog.scrollHeight;
      console.log(`[${timestamp}] ${message}`);
    }

    addDebugLog('=== PAYMENT DEBUG STARTED ===');
    addDebugLog('Order ID: {{ order_id }}');
    addDebugLog('Amount: {{ amount }} paise');
    addDebugLog('Razorpay Key: {{ razorpay_key }}');

    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ amount }}",
        "currency": "INR",
        "name": "Payment Debug Test",
        "description": "Testing Payment Flow - ‚Çπ1",
        "order_id": "{{ order_id }}",
        
        "handler": function (response) {
            addDebugLog('=== PAYMENT SUCCESS HANDLER CALLED ===');
            addDebugLog('Payment ID: ' + response.razorpay_payment_id);
            addDebugLog('Order ID: ' + response.razorpay_order_id);
            addDebugLog('Signature: ' + response.razorpay_signature);
            
            updateStatus("‚úÖ Payment successful! Verifying...", "green");
            
            // Validate response
            if (!response.razorpay_payment_id || !response.razorpay_order_id || !response.razorpay_signature) {
                addDebugLog('ERROR: Missing required fields in payment response');
                updateStatus("‚ùå Incomplete payment response", "red");
                return;
            }
            
            // Prepare data for backend
            const formData = new FormData();
            formData.append('razorpay_payment_id', response.razorpay_payment_id);
            formData.append('razorpay_order_id', response.razorpay_order_id);
            formData.append('razorpay_signature', response.razorpay_signature);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            addDebugLog('=== SENDING TO BACKEND ===');
            addDebugLog('URL: /payment/verify/');
            addDebugLog('Method: POST');
            
            updateStatus("üì§ Sending to backend for verification...", "blue");
            
            fetch("/payment/verify/", {
                method: "POST",
                body: formData,
                credentials: 'same-origin'  // Important for Django CSRF
            })
            .then(response => {
                addDebugLog('Backend response status: ' + response.status);
                addDebugLog('Backend response ok: ' + response.ok);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return response.json();
            })
            .then(data => {
                addDebugLog('=== BACKEND RESPONSE ===');
                addDebugLog(JSON.stringify(data, null, 2));
                
                if (data.status === "success") {
                    updateStatus("‚úÖ Payment verified successfully! Redirecting...", "green");
                    addDebugLog('SUCCESS: Payment verified, redirecting to success page');
                    setTimeout(() => {
                        window.location.href = "/payment/success/";
                    }, 2000);
                } else {
                    const errorMsg = data.error || "Unknown verification error";
                    updateStatus("‚ùå Verification failed: " + errorMsg, "red");
                    addDebugLog('ERROR: Backend verification failed - ' + errorMsg);
                }
            })
            .catch(error => {
                addDebugLog('=== FETCH ERROR ===');
                addDebugLog('Error: ' + error.message);
                addDebugLog('Stack: ' + error.stack);
                updateStatus("‚ùå Network error: " + error.message, "red");
            });
        },
        
        "prefill": {
            "name": "Test User",
            "email": "test@example.com",
            "contact": "9999999999"
        },
        
        "modal": {
            "ondismiss": function() {
                addDebugLog('=== PAYMENT CANCELLED ===');
                addDebugLog('User dismissed payment modal');
                updateStatus("‚ùå Payment cancelled by user", "orange");
            }
        },
        
        "theme": {
            "color": "#0f9d58"
        }
    };

    addDebugLog('=== INITIALIZING RAZORPAY ===');
    
    try {
        updateStatus("üöÄ Opening Razorpay checkout...", "blue");
        var rzp1 = new Razorpay(options);
        
        rzp1.on('payment.failed', function (response) {
            addDebugLog('=== PAYMENT FAILED ===');
            addDebugLog('Error code: ' + response.error.code);
            addDebugLog('Error description: ' + response.error.description);
            addDebugLog('Error source: ' + response.error.source);
            addDebugLog('Error step: ' + response.error.step);
            addDebugLog('Error reason: ' + response.error.reason);
            updateStatus("‚ùå Payment failed: " + response.error.description, "red");
        });
        
        rzp1.open();
        updateStatus("üí≥ Payment modal opened - Complete your payment", "blue");
        addDebugLog('Payment modal opened successfully');
        
    } catch (error) {
        addDebugLog('=== RAZORPAY INITIALIZATION ERROR ===');
        addDebugLog('Error: ' + error.message);
        updateStatus("‚ùå Failed to initialize payment: " + error.message, "red");
    }
  </script>
  
  {% endif %}

  <div style="margin-top:30px; padding:20px; background:#fff; border-radius:8px; max-width:600px; margin:30px auto;">
    <h3>Debug Instructions:</h3>
    <ol style="text-align:left;">
      <li><strong>Watch the debug log above</strong> - Real-time status updates</li>
      <li><strong>Open browser console (F12)</strong> - Check for errors</li>
      <li><strong>Check Django terminal</strong> - Look for backend logs</li>
      <li><strong>Complete the payment</strong> - Use any payment method</li>
      <li><strong>If verification fails</strong> - Check the exact error message</li>
    </ol>
    
    <div style="background:#fff3cd; padding:15px; margin-top:15px; border-radius:5px; text-align:left;">
      <h4>‚ö†Ô∏è Important:</h4>
      <p>If payment succeeds but verification fails, the money will show as "attempted" in Razorpay dashboard. This means the payment needs to be captured manually or refunded.</p>
    </div>
  </div>
</body>
</html>