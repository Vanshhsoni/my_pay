<!DOCTYPE html>
<html>
<head>
  <title>Razorpay Live Payment Debug</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body style="text-align:center; background:#e8f5e9; font-family:Arial; padding:20px;">
  <h2>🔍 Razorpay Live Payment Debug</h2>
  
  {% if error %}
  <div style="background:#ffebee; color:#c62828; padding:15px; margin:20px auto; max-width:600px; border-radius:8px;">
    <h3>Error:</h3>
    <p>{{ error }}</p>
  </div>
  {% endif %}
  
  {% if not order_id and not error %}
  <div style="background:#fff3cd; padding:15px; margin:20px auto; max-width:600px; border-radius:8px;">
    <h3>⚠️ Live Payment Mode Detected</h3>
    <p>You're using live Razorpay keys. Make sure:</p>
    <ul style="text-align: left;">
      <li>✅ Your Razorpay account is activated</li>
      <li>✅ Domain is added to authorized domains</li>
      <li>✅ You have real payment methods available</li>
    </ul>
  </div>
  
  <form method="POST">
    {% csrf_token %}
    <button type="submit" style="padding:12px 20px; background:#ff6b35; color:white; border:none; border-radius:8px; font-size:16px;">
      🚀 Start Live Payment Test (₹1)
    </button>
  </form>
  {% endif %}

  {% if order_id %}
  <div id="debug-info" style="background:#fff3cd; padding:15px; margin:20px auto; max-width:600px; border-radius:8px; text-align:left;">
    <h3>Debug Information:</h3>
    <p><strong>🆔 Order ID:</strong> <code>{{ order_id }}</code></p>
    <p><strong>💰 Amount:</strong> {{ amount }} paise (₹1)</p>
    <p><strong>🔑 Razorpay Key:</strong> <code>{{ razorpay_key }}</code></p>
    <p><strong>🌐 Mode:</strong> <span style="color: #e91e63; font-weight: bold;">LIVE</span></p>
  </div>

  <div id="status" style="margin:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
    <p id="current-status">🔄 Initializing live payment...</p>
  </div>

  <!-- Enhanced debug log -->
  <div id="payment-log" style="margin:20px; padding:15px; background:#f9f9f9; border-radius:8px; text-align:left; font-family:monospace; font-size:12px; max-height:400px; overflow-y:scroll; white-space: pre-wrap; border: 1px solid #ddd;"></div>

  <script>
    let paymentCompleted = false;
    let modalDismissed = false;

    function log(message, level = 'info') {
      const logEl = document.getElementById('payment-log');
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        'info': '#333',
        'success': '#4caf50', 
        'error': '#f44336',
        'warning': '#ff9800'
      };
      
      const logMessage = `[${timestamp}] ${message}\n`;
      logEl.textContent += logMessage;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(`%c${logMessage}`, `color: ${colors[level] || '#333'}`);
    }

    function updateStatus(message, color = '#333') {
      document.getElementById('current-status').innerHTML = message;
      document.getElementById('current-status').style.color = color;
      log('STATUS: ' + message);
    }

    // Test endpoint connectivity
    log('🧪 Testing verify endpoint connectivity...');
    fetch('/payment/verify/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': '{{ csrf_token }}'
      },
      body: 'test=true'
    })
    .then(response => {
      if (response.ok) {
        log('✅ Verify endpoint is reachable', 'success');
      } else {
        log('❌ Verify endpoint returned status: ' + response.status, 'error');
      }
    })
    .catch(error => {
      log('❌ Verify endpoint test failed: ' + error.message, 'error');
    });

    log('🚀 Starting Razorpay live payment integration...');
    log('📋 Order details:');
    log('   • Order ID: {{ order_id }}');
    log('   • Amount: ₹1 (100 paise)');
    log('   • Mode: LIVE');

    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ amount }}",
        "currency": "INR",
        "name": "Live Payment Test",
        "description": "Testing live payment flow - ₹1",
        "order_id": "{{ order_id }}",
        
        "handler": function (response) {
            paymentCompleted = true;
            log('🎉 SUCCESS: Payment completed successfully!', 'success');
            log('📄 Payment response received:');
            log('   • Payment ID: ' + response.razorpay_payment_id);
            log('   • Order ID: ' + response.razorpay_order_id);
            log('   • Signature: ' + response.razorpay_signature.substring(0, 20) + '...');
            
            updateStatus("✅ Payment successful! Verifying with server...", "#4caf50");
            
            // Validate response
            const requiredFields = ['razorpay_payment_id', 'razorpay_order_id', 'razorpay_signature'];
            const missingFields = requiredFields.filter(field => !response[field]);
            
            if (missingFields.length > 0) {
                log('❌ Missing required fields: ' + missingFields.join(', '), 'error');
                updateStatus("❌ Incomplete payment response", "#f44336");
                return;
            }

            log('📤 Sending verification request to server...');

            const formData = new URLSearchParams();
            formData.append('razorpay_payment_id', response.razorpay_payment_id);
            formData.append('razorpay_order_id', response.razorpay_order_id);
            formData.append('razorpay_signature', response.razorpay_signature);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            updateStatus("🔄 Verifying payment with server...", "#2196f3");

            fetch('/payment/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData.toString()
            })
            .then(response => {
                log('📡 Server response status: ' + response.status);
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                log('📋 Server verification response:');
                log('   • Status: ' + data.status);
                log('   • Message: ' + (data.message || 'No message'));
                
                if (data.status === 'success') {
                    log('🎊 VERIFICATION SUCCESSFUL!', 'success');
                    updateStatus("✅ Payment verified! Redirecting to success page...", "#4caf50");
                    
                    setTimeout(() => {
                        log('🔄 Redirecting to success page...', 'info');
                        window.location.href = '/payment/success/';
                    }, 2000);
                } else {
                    log('❌ Server verification failed: ' + (data.error || 'Unknown error'), 'error');
                    updateStatus("❌ Payment verification failed: " + (data.error || 'Unknown error'), "#f44336");
                }
            })
            .catch(error => {
                log('❌ Verification request failed: ' + error.message, 'error');
                updateStatus("❌ Failed to verify payment: " + error.message, "#f44336");
            });
        },
        
        "prefill": {
            "name": "Test User",
            "email": "test@example.com",
            "contact": "9999999999"
        },
        
        "notes": {
            "purpose": "Live payment test"
        },
        
        "modal": {
            "ondismiss": function() {
                modalDismissed = true;
                if (!paymentCompleted) {
                    log('❌ Payment modal closed without completion', 'warning');
                    updateStatus("❌ Payment cancelled by user", "#ff9800");
                } else {
                    log('ℹ️ Modal closed after successful payment', 'info');
                }
            }
        },
        
        "theme": {
            "color": "#0f9d58"
        }
    };

    try {
        log('🔧 Creating Razorpay instance...');
        var rzp1 = new Razorpay(options);
        
        rzp1.on('payment.failed', function (response) {
            log('💥 PAYMENT FAILED EVENT TRIGGERED', 'error');
            log('❌ Failure details:');
            log('   • Code: ' + response.error.code);
            log('   • Description: ' + response.error.description);
            log('   • Source: ' + response.error.source);
            log('   • Step: ' + response.error.step);
            log('   • Reason: ' + response.error.reason);
            
            updateStatus("❌ Payment failed: " + response.error.description, "#f44336");
        });
        
        log('🎯 Opening Razorpay payment modal...');
        updateStatus("🚀 Opening payment modal...", "#2196f3");
        
        rzp1.open();
        
        log('✅ Payment modal opened successfully');
        updateStatus("💳 Payment modal opened - complete your payment", "#2196f3");
        
        // Set timeout to check if payment was completed
        setTimeout(() => {
            if (!paymentCompleted && !modalDismissed) {
                log('⏰ Payment taking longer than expected...', 'warning');
                log('💡 This is normal for live payments - user might be completing payment');
            }
        }, 30000); // 30 seconds
        
    } catch (error) {
        log('💥 Failed to initialize Razorpay: ' + error.message, 'error');
        updateStatus("❌ Failed to initialize payment: " + error.message, "#f44336");
    }
  </script>
  
  {% endif %}

  <div style="margin-top:30px; padding:20px; background:#fff; border-radius:8px; max-width:600px; margin:30px auto;">
    <h3>🔍 Live Payment Debug Guide</h3>
    <div style="text-align:left;">
      <h4>🎯 What We're Looking For:</h4>
      <p><strong>Success Flow:</strong></p>
      <ol>
        <li>✅ Payment modal opens</li>
        <li>✅ User completes payment</li>
        <li>✅ "Payment completed successfully!" appears</li>
        <li>✅ Verification request sent to server</li>
        <li>✅ Server returns success</li>
        <li>✅ Redirect to success page</li>
      </ol>
      
      <h4>❌ If Payment Handler Doesn't Trigger:</h4>
      <ul>
        <li>Check if your Razorpay account is fully activated</li>
        <li>Verify domain authorization in Razorpay dashboard</li>
        <li>Try with a different payment method</li>
        <li>Check for console errors during payment</li>
      </ul>
    </div>
    
    <div style="background:#e8f5e9; padding:15px; margin-top:15px; border-radius:5px; text-align:left;">
      <h4>💡 Pro Tip:</h4>
      <p>Since you're using <strong>live keys</strong>, actual money will be deducted. For testing, consider:</p>
      <ul>
        <li>Using test keys first: <code>rzp_test_...</code></li>
        <li>Setting up refunds for test transactions</li>
        <li>Using the smallest amount possible (₹1)</li>
      </ul>
    </div>
  </div>
</body>
</html>