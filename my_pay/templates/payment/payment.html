<!DOCTYPE html>
<html>
<head>
  <title>Payment Debug - Verification Issue</title>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body style="text-align:center; background:#e8f5e9; font-family:Arial; padding:20px;">
  <h2>Payment Debug - Fixing Verification</h2>
  
  {% if error %}
  <div style="background:#ffebee; color:#c62828; padding:15px; margin:20px auto; max-width:600px; border-radius:8px;">
    <h3>Error:</h3>
    <p>{{ error }}</p>
  </div>
  {% endif %}
  
  {% if not order_id and not error %}
  <form method="POST">
    {% csrf_token %}
    <button type="submit" style="padding:12px 20px; background:green; color:white; border:none; border-radius:8px;">
      Pay ‚Çπ1 (Debug Mode)
    </button>
  </form>
  {% endif %}

  {% if order_id %}
  <div id="debug-info" style="background:#fff3cd; padding:15px; margin:20px auto; max-width:600px; border-radius:8px; text-align:left;">
    <h3>Debug Information:</h3>
    <p><strong>Order ID:</strong> {{ order_id }}</p>
    <p><strong>Amount:</strong> {{ amount }} paise (‚Çπ1)</p>
    <p><strong>Razorpay Key:</strong> {{ razorpay_key }}</p>
    <p><strong>Verify URL:</strong> <code>/payment/verify/</code></p>
  </div>

  <div id="status" style="margin:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
    <p id="current-status">Starting payment process...</p>
  </div>

  <!-- Simple debug log -->
  <div id="simple-log" style="margin:20px; padding:15px; background:#f9f9f9; border-radius:8px; text-align:left; font-family:monospace; font-size:12px; max-height:300px; overflow-y:scroll; white-space: pre-wrap;"></div>

  <script>
    // Simple logging function
    function log(message) {
      const logEl = document.getElementById('simple-log');
      const timestamp = new Date().toLocaleTimeString();
      const logMessage = `[${timestamp}] ${message}\n`;
      logEl.textContent += logMessage;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(logMessage);
    }

    function updateStatus(message, color = '#333') {
      document.getElementById('current-status').innerHTML = message;
      document.getElementById('current-status').style.color = color;
      log('STATUS: ' + message);
    }

    // Test if verification endpoint is reachable
    function testVerifyEndpoint() {
      log('=== TESTING VERIFY ENDPOINT ===');
      
      fetch('/payment/verify/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'test=true'
      })
      .then(response => {
        log(`Verify endpoint test - Status: ${response.status}`);
        return response.text();
      })
      .then(text => {
        log(`Verify endpoint test - Response: ${text.substring(0, 100)}...`);
      })
      .catch(error => {
        log(`Verify endpoint test - ERROR: ${error.message}`);
      });
    }

    // Test the endpoint first
    testVerifyEndpoint();

    log('=== INITIALIZING RAZORPAY ===');
    log('Order ID: {{ order_id }}');
    log('Amount: {{ amount }}');
    log('Key: {{ razorpay_key }}');

    var options = {
        "key": "{{ razorpay_key }}",
        "amount": "{{ amount }}",
        "currency": "INR",
        "name": "Debug Payment",
        "description": "Testing verification flow",
        "order_id": "{{ order_id }}",
        
        "handler": function (response) {
            log('=== PAYMENT SUCCESS HANDLER TRIGGERED ===');
            log('This means payment was completed successfully!');
            log('Payment ID: ' + response.razorpay_payment_id);
            log('Order ID: ' + response.razorpay_order_id);
            log('Signature: ' + response.razorpay_signature);
            
            updateStatus("‚úÖ Payment completed! Now verifying...", "green");
            
            // Check if all required fields are present
            if (!response.razorpay_payment_id) {
                log('ERROR: Missing razorpay_payment_id');
                updateStatus("‚ùå Missing payment ID", "red");
                return;
            }
            if (!response.razorpay_order_id) {
                log('ERROR: Missing razorpay_order_id');
                updateStatus("‚ùå Missing order ID", "red");
                return;
            }
            if (!response.razorpay_signature) {
                log('ERROR: Missing razorpay_signature');
                updateStatus("‚ùå Missing signature", "red");
                return;
            }

            // Prepare form data
            const formData = new URLSearchParams();
            formData.append('razorpay_payment_id', response.razorpay_payment_id);
            formData.append('razorpay_order_id', response.razorpay_order_id);
            formData.append('razorpay_signature', response.razorpay_signature);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            log('=== SENDING VERIFICATION REQUEST ===');
            log('URL: /payment/verify/');
            log('Data: ' + formData.toString());

            updateStatus("üì§ Sending verification request...", "blue");

            fetch('/payment/verify/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData.toString()
            })
            .then(response => {
                log(`Verification response status: ${response.status}`);
                log(`Verification response ok: ${response.ok}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return response.json();
            })
            .then(data => {
                log('=== VERIFICATION RESPONSE ===');
                log('Response data: ' + JSON.stringify(data, null, 2));
                
                if (data.status === 'success') {
                    updateStatus("‚úÖ Verification successful! Redirecting...", "green");
                    log('SUCCESS: Redirecting to success page');
                    
                    setTimeout(() => {
                        window.location.href = '/payment/success/';
                    }, 2000);
                } else {
                    updateStatus("‚ùå Verification failed: " + (data.error || 'Unknown error'), "red");
                    log('VERIFICATION FAILED: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                log('=== VERIFICATION REQUEST FAILED ===');
                log('Error: ' + error.message);
                log('This means the request to /payment/verify/ failed');
                updateStatus("‚ùå Verification request failed: " + error.message, "red");
            });
        },
        
        "prefill": {
            "name": "Test User",
            "email": "test@example.com",
            "contact": "9999999999"
        },
        
        "modal": {
            "ondismiss": function() {
                log('=== PAYMENT MODAL DISMISSED ===');
                log('User cancelled payment');
                updateStatus("‚ùå Payment cancelled", "orange");
            }
        },
        
        "theme": {
            "color": "#0f9d58"
        }
    };

    try {
        log('Creating Razorpay instance...');
        var rzp1 = new Razorpay(options);
        
        rzp1.on('payment.failed', function (response) {
            log('=== PAYMENT FAILED EVENT ===');
            log('Error: ' + JSON.stringify(response.error, null, 2));
            updateStatus("‚ùå Payment failed: " + response.error.description, "red");
        });
        
        log('Opening Razorpay modal...');
        updateStatus("üöÄ Opening payment modal...", "blue");
        
        rzp1.open();
        
        updateStatus("üí≥ Payment modal opened - complete your payment", "blue");
        log('Modal opened successfully');
        
    } catch (error) {
        log('=== RAZORPAY INITIALIZATION ERROR ===');
        log('Error: ' + error.message);
        updateStatus("‚ùå Failed to initialize Razorpay: " + error.message, "red");
    }
  </script>
  
  {% endif %}

  <div style="margin-top:30px; padding:20px; background:#fff; border-radius:8px; max-width:600px; margin:30px auto;">
    <h3>üîç What This Debug Version Does:</h3>
    <ol style="text-align:left;">
      <li><strong>Tests verify endpoint</strong> before payment</li>
      <li><strong>Logs every step</strong> of the payment process</li>
      <li><strong>Shows exactly where it fails</strong> (if it does)</li>
      <li><strong>Uses simplified request handling</strong></li>
    </ol>
    
    <div style="background:#e3f2fd; padding:15px; margin-top:15px; border-radius:5px; text-align:left;">
      <h4>üìã What to Check:</h4>
      <p><strong>1. Does "PAYMENT SUCCESS HANDLER TRIGGERED" appear?</strong><br>
         - If NO: Payment isn't completing successfully</p>
      <p><strong>2. Does verification request get sent?</strong><br>
         - If NO: JavaScript error preventing the request</p>
      <p><strong>3. Does Django log show verification endpoint being hit?</strong><br>
         - If NO: Request isn't reaching your server</p>
    </div>
  </div>
</body>
</html>